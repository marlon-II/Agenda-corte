<!DOCTYPE html>
<html>
<head>
    <title>Cadastrar Agendamento</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

    <div class="container py-5">
        <form id="formAgenda" onsubmit="agendar(event)">
            <h3 class="text-center mb-4">Agendamento</h3>

            <div class="mb-3">
                <label class="form-label">Nome do Cliente</label>
                <input id="nomeC" type="text" class="form-control" placeholder="Nome do Cliente" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Data</label>
                <input id="data" type="date" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Horário</label>
                <input id="hora" type="time" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Tipo de Corte</label>
                <input id="corte" type="text" class="form-control" placeholder="Tipo de Corte" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Barbeiro</label>
                <input id="nomeF" type="text" class="form-control" placeholder="Nome do Barbeiro" required>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-secondary">Cadastrar</button>
                <a href="/Menu" class="btn btn-light">Voltar</a>
            </div>
        </form>
    </div>

    <script>
        // Função para agendar o corte
        async function agendar(event) {
            event.preventDefault();

            // Chama a função de busca e aguarda os resultados
            const ids = await buscarIdPorNome();

            if (!ids) return;  // Se algum dos IDs não for encontrado, não prossegue

            // Extrai os valores de ID dos resultados da busca
            const { id_cliente, id_tipo_corte, id_barbeiro } = ids;
            const data = document.getElementById("data").value;
            const hora = document.getElementById("hora").value;

            // Envia o agendamento para o servidor
            fetch('/agendamento/adicionar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_cliente,        // Envia o ID do cliente
                    data_marcada: data,
                    hora,
                    id_tipo_corte,    // Envia o ID do tipo de corte
                    id_barbeiro       // Envia o ID do barbeiro
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Agendamento realizado:", data);
                // Aqui você pode exibir uma mensagem de sucesso ou redirecionar o usuário
            })
            .catch(error => {
                console.error('Erro ao agendar:', error);
                alert("Erro ao agendar. Tente novamente.");
            });
        }

        // Função que busca os IDs necessários para o agendamento
        async function buscarIdPorNome() {
            const nomeC = document.getElementById("nomeC").value;
            const corte = document.getElementById("corte").value;
            const nomeF = document.getElementById("nomeF").value;

            try {
                const ids = {};

                // Buscar o ID do cliente
                if (nomeC) {
                    const responseCliente = await fetch(`/cliente/id/${nomeC}`);
                    const id_cliente = await responseCliente.json();
                    if (id_cliente) {
                        ids.id_cliente = id_cliente;
                    } else {
                        alert("Cliente não encontrado!");
                        return null;
                    }
                }

                // Buscar o ID do corte
                if (corte) {
                    const responseCorte = await fetch(`/servico/id/${corte}`);
                    const id_tipo_corte = await responseCorte.json();
                    if (id_tipo_corte) {
                        ids.id_tipo_corte = id_tipo_corte;
                    } else {
                        alert("Tipo de corte não encontrado!");
                        return null;
                    }
                }

                // Buscar o ID do barbeiro
                if (nomeF) {
                    const responseFuncionario = await fetch(`/funcionario/id/${nomeF}`);
                    const id_barbeiro = await responseFuncionario.json();
                    if (id_barbeiro) {
                        ids.id_barbeiro = id_barbeiro;
                    } else {
                        alert("Barbeiro não encontrado!");
                        return null;
                    }
                }

                return ids; // Retorna os IDs encontrados
            } catch (error) {
                console.error('Erro na busca dos IDs:', error);
                alert("Erro ao buscar os dados. Tente novamente.");
            }
        }
    </script>
</body>
</html>
